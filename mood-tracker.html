<!DOCTYPE html>
<html lang="en">

<head>
  <script src="auth.js"></script>
  <meta charset="UTF-8" />
  <title>Mood Tracker | Mindful Haven</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link href="mobile-responsive.css" rel="stylesheet">
  <style>
    :root {
      /* Light Mode - Calming Sage Palette */
      --sage-gradient: linear-gradient(135deg, #c9dcc4 0%, #d4c5e8 100%);
      --sage-dark: #5a6b56;
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --text-dark: #111827;
      --text-muted: #6b7280;
      --accent: #6366f1;
      --accent-soft: #eef2ff;
      --border-light: #e5e7eb;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(255, 255, 255, 0.7);
      --mood-very-bad: #ef4444;
      --mood-bad: #f97316;
      --mood-okay: #eab308;
      --mood-good: #84cc16;
      --mood-great: #22c55e;
    }

    [data-theme="dark"] {
      /* Dark Mode - Restful Slate Palette (WCAG Compliant) */
      --sage-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      --sage-dark: #94a3b8;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --text-dark: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #8b5cf6;
      --accent-soft: #312e81;
      --border-light: #334155;
      --glass-bg: rgba(30, 41, 59, 0.9);
      --glass-border: rgba(71, 85, 105, 0.7);
      --mood-very-bad: #ef4444;
      --mood-bad: #f97316;
      --mood-okay: #eab308;
      --mood-good: #84cc16;
      --mood-great: #22c55e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Plus Jakarta Sans", sans-serif;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-dark);
      padding-bottom: 60px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 8%;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-light);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--sage-dark);
    }

    .logo i {
      font-size: 1.3rem;
    }

    .nav-center {
      display: flex;
      gap: 28px;
      list-style: none;
    }

    .nav-center a {
      text-decoration: none;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-center a.active {
      color: var(--sage-dark);
      font-weight: 600;
    }

    .nav-center a:hover {
      color: var(--accent);
    }

    .nav-right {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .nav-right a {
      text-decoration: none;
      color: var(--text-muted);
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav-right a:hover {
      color: var(--accent);
    }

    /* Dark mode toggle - Smooth glassmorphism */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--glass-bg);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
      backdrop-filter: blur(12px);
    }

    .theme-toggle:hover {
      background: var(--glass-border);
      transform: translateY(-1px);
    }

    .theme-toggle.active {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .hero-strip {
      padding: 40px 8% 30px;
      background: var(--sage-gradient);
      transition: background 0.5s ease;
      position: relative;
      overflow: hidden;
    }

    .botanical-left,
    .botanical-right {
      position: absolute;
      opacity: 0.4;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 0;
    }

    .botanical-left {
      left: -50px;
      top: 0;
      width: 300px;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 400"><path d="M50,50 Q80,100 50,150 T50,250 T50,350" stroke="%235a6b56" stroke-width="3" fill="none" opacity="0.3"/><ellipse cx="70" cy="80" rx="30" ry="15" fill="%2387a383" opacity="0.4" transform="rotate(-20 70 80)"/><ellipse cx="30" cy="130" rx="35" ry="18" fill="%2387a383" opacity="0.4" transform="rotate(15 30 130)"/><ellipse cx="65" cy="200" rx="28" ry="14" fill="%2387a383" opacity="0.4" transform="rotate(-25 65 200)"/></svg>') no-repeat;
      background-size: contain;
    }

    .botanical-right {
      right: -50px;
      top: 0;
      width: 300px;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 400"><path d="M150,50 Q120,100 150,150 T150,250 T150,350" stroke="%235a6b56" stroke-width="3" fill="none" opacity="0.3"/><ellipse cx="130" cy="80" rx="30" ry="15" fill="%2387a383" opacity="0.4" transform="rotate(20 130 80)"/><ellipse cx="170" cy="130" rx="35" ry="18" fill="%2387a383" opacity="0.4" transform="rotate(-15 170 130)"/><ellipse cx="135" cy="200" rx="28" ry="14" fill="%2387a383" opacity="0.4" transform="rotate(25 135 200)"/></svg>') no-repeat;
      background-size: contain;
    }

    [data-theme="dark"] .botanical-left,
    [data-theme="dark"] .botanical-right {
      opacity: 0.15;
    }

    .hero-inner {
      max-width: 1000px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .mindful-buddies {
      position: absolute;
      bottom: 15px;
      right: 8%;
      width: 150px;
      height: 110px;
      z-index: 2;
      opacity: 0.85;
      pointer-events: none;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"><g transform="translate(80, 100)"><ellipse cx="0" cy="0" rx="35" ry="45" fill="%23ffc9b5" /><path d="M-35,-15 Q0,-45 35,-15" fill="%235a6b56" /><ellipse cx="-20" cy="-25" rx="12" ry="8" fill="%2387a383" transform="rotate(-20)" /><ellipse cx="20" cy="-25" rx="12" ry="8" fill="%2387a383" transform="rotate(20)" /><path d="M-10,5 Q-5,8 0,5 M10,5 Q15,8 20,5" stroke="%23374151" stroke-width="2" fill="none" opacity="0.6"/><path d="M-5,20 Q5,28 15,20" stroke="%23374151" stroke-width="2" fill="none" /></g><g transform="translate(200, 110)"><ellipse cx="0" cy="0" rx="38" ry="48" fill="%23ffc9b5" /><path d="M-38,-15 Q0,-48 38,-15" fill="%235a6b56" /><ellipse cx="-22" cy="-28" rx="14" ry="9" fill="%2387a383" transform="rotate(-15)" /><ellipse cx="22" cy="-28" rx="14" ry="9" fill="%2387a383" transform="rotate(15)" /><path d="M-12,5 Q-6,8 0,5 M12,5 Q18,8 24,5" stroke="%23374151" stroke-width="2" fill="none" opacity="0.6"/><path d="M-6,22 Q6,30 18,22" stroke="%23374151" stroke-width="2" fill="none" /></g><circle cx="40" cy="40" r="10" fill="%23d4c5e8" opacity="0.5" /><circle cx="260" cy="160" r="8" fill="%23d4c5e8" opacity="0.5" /></svg>') no-repeat center/contain;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);

      }
    }

    @keyframes fadeInBounce {
      0% {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
      }

      60% {
        opacity: 1;
        transform: translateY(-5px) scale(1.05);
      }

      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .affirmation-bubble {
      position: absolute;
      bottom: 145px;
      right: 8%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
      backdrop-filter: blur(16px);
      border: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 24px;
      padding: 16px 22px;
      max-width: 260px;
      z-index: 3;
      box-shadow: 0 12px 32px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);
      animation: fadeInBounce 1.2s ease-out 0.8s both;
    }

    [data-theme="dark"] .affirmation-bubble {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
      border-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .affirmation-bubble p {
      margin: 0;
      font-size: 0.95rem;
      color: var(--text-dark);
      font-weight: 600;
      line-height: 1.5;
      text-align: center;
    }

    .hero-title {
      font-family: "Playfair Display", serif;
      font-size: 2.1rem;
      margin-bottom: 6px;
      color: var(--text-dark);
    }

    .hero-sub {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .main {
      padding: 24px 8%;
    }

    .main-inner {
      max-width: 1000px;
      margin: 0 auto;
    }

    .card {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border-light);
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      transition: all 0.3s;
    }

    .card:hover {
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    }

    .card h3 {
      font-size: 1.15rem;
      margin-bottom: 8px;
      color: var(--text-dark);
    }

    .card .sub {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border-light);
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }

    /* Special styling for best day stat since it shows a date */
    #bestDay {
      font-size: 1.3rem;
      line-height: 1.2;
    }

    /* Mood Scale */
    .mood-scale {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin: 20px 0;
    }

    .mood-btn {
      flex: 1;
      padding: 16px 12px;
      border: 2px solid var(--border-light);
      border-radius: 16px;
      background: var(--bg-primary);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 1.8rem;
    }

    .mood-btn:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      transform: translateY(-4px);
    }

    .mood-btn.selected {
      border-color: var(--accent);
      background: var(--accent-soft);
      transform: scale(1.08);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
    }

    .mood-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 8px;
      display: block;
    }

    /* Activity Factors */
    .factors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }

    .factor-checkbox {
      position: relative;
    }

    .factor-checkbox input {
      position: absolute;
      opacity: 0;
    }

    .factor-checkbox label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border: 2px solid var(--border-light);
      border-radius: 12px;
      background: var(--bg-primary);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .factor-checkbox label i {
      font-size: 1.1rem;
    }

    .factor-checkbox input:checked+label {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .factor-checkbox label:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    /* Input Groups */
    .input-group {
      margin: 20px 0;
    }

    .input-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-dark);
    }

    .input-group input,
    .input-group textarea,
    .input-group select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border-light);
      font-size: 0.95rem;
      background: var(--bg-primary);
      color: var(--text-dark);
      transition: all 0.3s;
      font-family: inherit;
    }

    .input-group input:focus,
    .input-group textarea:focus,
    .input-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .input-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Time Period Selector */
    .period-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .period-btn {
      padding: 8px 16px;
      border-radius: 999px;
      background: var(--bg-primary);
      color: var(--text-muted);
      border: 1px solid var(--border-light);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .period-btn:hover {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
    }

    .period-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Save Button */
    .btn-primary {
      width: 100%;
      padding: 14px;
      border-radius: 999px;
      background: var(--text-dark);
      color: #fff;
      border: none;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary:hover {
      background: #000;
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    }

    /* Mood Chart */
    .chart-container {
      position: relative;
      height: 250px;
      margin: 24px 0;
      padding: 20px;
      background: var(--bg-primary);
      border-radius: 16px;
      border: 1px solid var(--border-light);
    }

    .chart-svg {
      width: 100%;
      height: 100%;
    }

    /* Mood History */
    .mood-entry {
      padding: 16px 20px;
      background: var(--bg-primary);
      border-radius: 16px;
      margin-bottom: 12px;
      border-left: 5px solid var(--accent);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .mood-entry::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: linear-gradient(45deg, var(--accent), var(--accent-soft));
    }

    .mood-entry:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      transform: translateX(8px);
    }

    .mood-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .mood-entry-date {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .mood-entry-mood {
      font-size: 1.5rem;
    }

    .mood-entry-factors {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
    }

    .factor-tag {
      background: var(--accent-soft);
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .mood-entry-note {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 8px;
      line-height: 1.6;
    }

    .mood-entry-energy {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* Insights Section */
    .insight-box {
      background: var(--accent-soft);
      border-left: 4px solid var(--accent);
      padding: 16px 20px;
      border-radius: 12px;
      margin: 16px 0;
      font-size: 0.95rem;
      color: var(--accent);
      position: relative;
      overflow: hidden;
    }

    .insight-box i {
      margin-right: 8px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state p {
      font-size: 1rem;
      line-height: 1.6;
    }

    @media(max-width:900px) {
      .nav-center {
        display: none;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .mood-scale {
        flex-wrap: wrap;
      }

      .mood-btn {
        flex-basis: calc(20% - 10px);
        font-size: 1.5rem;
      }

      .factors-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .chart-container {
        height: 200px;
      }
    }
  </style>
</head>

<body>
  <nav>
    <div class="logo"><i class="fas fa-brain"></i> Mindful Haven</div>
    <ul class="nav-center">
      <li><a href="healing-journey.html">Journey</a></li>
      <li><a href="mood-tracker.html" class="active">Mood</a></li>
      <li><a href="journal.html">Journal</a></li>
      <li><a href="crisis.html">Crisis</a></li>
    </ul>
    <div class="nav-right">
      <div class="theme-toggle" id="themeToggle" data-theme="light">
        <i class="fas fa-sun"></i>
        <span>Light</span>
      </div>
      <a href="counselors.html"><i class="fas fa-user-md"></i> Support</a>
    </div>
  </nav>

  <section class="hero-strip">
    <div class="botanical-left"></div>
    <div class="botanical-right"></div>
    <div class="mindful-buddies"></div>
    <div class="hero-inner">
      <h1 class="hero-title">Daily Mood Tracker</h1>
      <p class="hero-sub">Track your emotions to identify patterns, triggers, and gain self-awareness</p>
    </div>
  </section>

  <main class="main">
    <div class="main-inner">
      <!-- Stats Dashboard -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalEntries">0</div>
          <div class="stat-label">Total Check-ins</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgMood">--</div>
          <div class="stat-label">Avg Mood (7d)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="bestDay">--</div>
          <div class="stat-label">Best Day</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="checkInStreak">0</div>
          <div class="stat-label">Check-in Days</div>
        </div>
      </div>

      <!-- Log Mood -->
      <div class="card">
        <h3>How are you feeling right now?</h3>
        <p class="sub">Select the emoji that best represents your current mood</p>

        <div class="mood-scale" id="moodScale">
          <div class="mood-btn" data-mood="1" title="Very bad">
            üò¢
            <span class="mood-label">Very Bad</span>
          </div>
          <div class="mood-btn" data-mood="2" title="Bad">
            üòü
            <span class="mood-label">Bad</span>
          </div>
          <div class="mood-btn" data-mood="3" title="Okay">
            üòê
            <span class="mood-label">Okay</span>
          </div>
          <div class="mood-btn" data-mood="4" title="Good">
            üôÇ
            <span class="mood-label">Good</span>
          </div>
          <div class="mood-btn" data-mood="5" title="Great">
            üòä
            <span class="mood-label">Great</span>
          </div>
        </div>

        <div class="input-group">
          <label>Energy Level</label>
          <select id="energyLevel">
            <option value="">Select your energy level</option>
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Moderate</option>
            <option value="4">High</option>
            <option value="5">Very High</option>
          </select>
        </div>

        <div class="input-group">
          <label>What influenced your mood? (Select all that apply)</label>
          <div class="factors-grid" id="factorsGrid">
            <div class="factor-checkbox">
              <input type="checkbox" id="sleep" value="sleep">
              <label for="sleep"><i class="fas fa-bed"></i> Sleep Quality</label>
            </div>
            <div class="factor-checkbox">
              <input type="checkbox" id="exercise" value="exercise">
              <label for="exercise"><i class="fas fa-running"></i> Exercise</label>
            </div>
            <div class="factor-checkbox">
              <input type="checkbox" id="social" value="social">
              <label for="social"><i class="fas fa-users"></i> Social Time</label>
            </div>
            <div class="factor-checkbox">
              <input type="checkbox" id="work" value="work">
              <label for="work"><i class="fas fa-briefcase"></i> Work Stress</label>
            </div>
            <div class="factor-checkbox">
              <input type="checkbox" id="weather" value="weather">
              <label for="weather"><i class="fas fa-cloud-sun"></i> Weather</label>
            </div>
            <div class="factor-checkbox">
              <input type="checkbox" id="food" value="food">
              <label for="food"><i class="fas fa-utensils"></i> Meals</label>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label>Additional notes (optional)</label>
          <textarea id="moodNote"
            placeholder="Any specific thoughts, events, or feelings you want to remember..."></textarea>
        </div>

        <button class="btn-primary" id="saveMood">Save Mood Check-in</button>
      </div>

      <!-- Mood Visualization -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <h3>Mood Trends</h3>
            <p class="sub">Visualize your emotional patterns over time</p>
          </div>
          <div class="period-selector">
            <button class="period-btn active" data-period="7" onclick="changePeriod(7)">7 Days</button>
            <button class="period-btn" data-period="14" onclick="changePeriod(14)">14 Days</button>
            <button class="period-btn" data-period="30" onclick="changePeriod(30)">30 Days</button>
          </div>
        </div>

        <div class="chart-container">
          <svg class="chart-svg" id="moodChart" viewBox="0 0 800 200" preserveAspectRatio="none"></svg>
        </div>
      </div>

      <!-- Pattern Insights -->
      <div class="card" id="insightsCard" style="display:none;">
        <h3>Pattern Insights</h3>
        <p class="sub">Based on your recent mood logs</p>
        <div id="insightsContent"></div>
      </div>

      <!-- Mood History -->
      <div class="card">
        <h3>Your Mood History</h3>
        <p class="sub">Recent check-ins with detailed context</p>
        <div id="moodHistory"></div>
      </div>
    </div>
  </main>

  <script>
    // ===== THEME MANAGEMENT =====
    function initTheme() {
      const savedTheme = localStorage.getItem('mh_theme') || 'light';
      const html = document.documentElement;
      html.setAttribute('data-theme', savedTheme);

      const toggle = document.getElementById('themeToggle');
      const icon = toggle.querySelector('i');
      const text = toggle.querySelector('span');

      if (savedTheme === 'dark') {
        toggle.classList.add('active');
        icon.className = 'fas fa-moon';
        text.textContent = 'Dark';
      } else {
        icon.className = 'fas fa-sun';
        text.textContent = 'Light';
      }
    }

    document.getElementById('themeToggle').addEventListener('click', function () {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('mh_theme', newTheme);

      const icon = this.querySelector('i');
      const text = this.querySelector('span');

      if (newTheme === 'dark') {
        this.classList.add('active');
        icon.className = 'fas fa-moon';
        text.textContent = 'Dark';
      } else {
        this.classList.remove('active');
        icon.className = 'fas fa-sun';
        text.textContent = 'Light';
      }
    });

    // ===== UTILITY FUNCTIONS =====
    function getUserKey(k) {
      // Check both storages for the current user
      const user = localStorage.getItem('mh_user') || sessionStorage.getItem('mh_user');
      return user ? `${user}_${k}` : k;
    }

    function safeRead(k) {
      try {
        const key = getUserKey(k);
        const r = localStorage.getItem(key);
        return r ? JSON.parse(r) : [];
      } catch {
        return [];
      }
    }
    function saveData(k, v) {
      const key = getUserKey(k);
      localStorage.setItem(key, JSON.stringify(v));
    }

    // ===== MOOD TRACKER =====
    let selectedMood = null;
    let currentPeriod = 7;
    const moodScale = document.getElementById("moodScale");
    const energyLevel = document.getElementById("energyLevel");
    const moodNote = document.getElementById("moodNote");
    const saveMoodBtn = document.getElementById("saveMood");
    const moodHistory = document.getElementById("moodHistory");

    // Mood selection
    moodScale.addEventListener("click", (e) => {
      if (e.target.classList.contains("mood-btn") || e.target.closest('.mood-btn')) {
        const btn = e.target.classList.contains("mood-btn") ? e.target : e.target.closest('.mood-btn');
        document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedMood = parseInt(btn.dataset.mood, 10);
      }
    });

    // Save mood
    saveMoodBtn.addEventListener("click", () => {
      if (!selectedMood) {
        alert("Please select a mood emoji first!");
        return;
      }

      const moods = safeRead("mh_moods");
      const now = new Date();
      const today = now.toISOString().split("T")[0];

      // Get selected factors
      const factors = [];
      document.querySelectorAll('.factor-checkbox input:checked').forEach(cb => {
        factors.push(cb.value);
      });

      const entry = {
        date: today,
        timestamp: now.toISOString(),
        mood: selectedMood,
        energy: energyLevel.value,
        factors: factors,
        note: moodNote.value.trim()
      };

      // Check if entry exists for today
      const existing = moods.findIndex(m => m.date === today);
      if (existing >= 0) {
        moods[existing] = entry;
      } else {
        moods.push(entry);
      }

      saveData("mh_moods", moods);
      alert("‚úì Mood check-in saved!");

      // Reset form
      selectedMood = null;
      energyLevel.value = "";
      moodNote.value = "";
      document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("selected"));
      document.querySelectorAll('.factor-checkbox input').forEach(cb => cb.checked = false);

      updateStats();
      renderHistory();
      renderChart();
      generateInsights();
    });

    // ===== STATS CALCULATION =====
    function updateStats() {
      const moods = safeRead("mh_moods");
      const total = moods.length;
      document.getElementById("totalEntries").textContent = total || 0;

      // Get last 7 days
      const last7Days = moods.slice(-7);

      // Average mood (last 7 days)
      if (last7Days.length > 0) {
        const avgMood = (last7Days.reduce((sum, e) => sum + e.mood, 0) / last7Days.length).toFixed(1);
        document.getElementById("avgMood").textContent = avgMood;
      } else {
        document.getElementById("avgMood").textContent = "--";
      }

      // Best day
      if (moods.length > 0) {
        const sortedByMood = [...moods].sort((a, b) => b.mood - a.mood);
        const bestEntry = sortedByMood[0];
        const bestDate = new Date(bestEntry.date);
        // Format as "Mon, Jan 17" for better clarity
        const formatted = bestDate.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric'
        });
        document.getElementById("bestDay").textContent = formatted;
      } else {
        document.getElementById("bestDay").textContent = "--";
      }

      // Unique check-in days
      const uniqueDays = new Set(moods.map(m => m.date)).size;
      document.getElementById("checkInStreak").textContent = uniqueDays;
    }

    // ===== MOOD CHART =====
    function renderChart() {
      const moods = safeRead("mh_moods");
      const svg = document.getElementById("moodChart");

      if (moods.length === 0) {
        svg.innerHTML = '<text x="400" y="100" text-anchor="middle" fill="var(--text-muted)" font-size="14">No data yet. Start tracking your mood!</text>';
        return;
      }

      // Get data for selected period
      const periodData = moods.slice(-currentPeriod);

      // Chart dimensions
      const width = 800;
      const height = 200;
      const padding = 40;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;

      // Clear SVG
      svg.innerHTML = '';

      // Draw gridlines
      for (let i = 1; i <= 5; i++) {
        const y = padding + (chartHeight / 5) * (6 - i);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', padding);
        line.setAttribute('y1', y);
        line.setAttribute('x2', width - padding);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', 'var(--border-light)');
        line.setAttribute('stroke-width', '1');
        svg.appendChild(line);

        // Y-axis labels
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', padding - 10);
        text.setAttribute('y', y + 5);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('fill', 'var(--text-muted)');
        text.setAttribute('font-size', '12');
        text.textContent = i;
        svg.appendChild(text);
      }

      // Plot points and line
      const points = periodData.map((entry, i) => {
        const x = padding + (chartWidth / (periodData.length - 1 || 1)) * i;
        const y = padding + chartHeight - (entry.mood / 5 * chartHeight);
        return { x, y, entry };
      });

      // Draw line
      if (points.length > 1) {
        const pathD = points.map((p, i) =>
          i === 0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`
        ).join(' ');

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathD);
        path.setAttribute('stroke', 'var(--accent)');
        path.setAttribute('stroke-width', '3');
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        svg.appendChild(path);
      }

      // Draw points
      const moodColors = ['', 'var(--mood-very-bad)', 'var(--mood-bad)', 'var(--mood-okay)', 'var(--mood-good)', 'var(--mood-great)'];
      points.forEach(p => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', p.x);
        circle.setAttribute('cy', p.y);
        circle.setAttribute('r', '6');
        circle.setAttribute('fill', moodColors[p.entry.mood]);
        circle.setAttribute('stroke', 'var(--bg-secondary)');
        circle.setAttribute('stroke-width', '2');
        svg.appendChild(circle);
      });
    }

    // Change period
    window.changePeriod = function (days) {
      currentPeriod = days;
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.period) === days);
      });
      renderChart();
    };

    // ===== INSIGHTS GENERATION =====
    function generateInsights() {
      const moods = safeRead("mh_moods");

      if (moods.length < 3) {
        document.getElementById("insightsCard").style.display = 'none';
        return;
      }

      document.getElementById("insightsCard").style.display = 'block';
      const insightsContent = document.getElementById("insightsContent");
      insightsContent.innerHTML = '';

      // Analyze factors
      const factorCounts = {};
      const factorMoodSum = {};

      moods.forEach(entry => {
        if (entry.factors && entry.factors.length > 0) {
          entry.factors.forEach(factor => {
            if (!factorCounts[factor]) {
              factorCounts[factor] = 0;
              factorMoodSum[factor] = 0;
            }
            factorCounts[factor]++;
            factorMoodSum[factor] += entry.mood;
          });
        }
      });

      // Find best factor
      let bestFactor = null;
      let bestAvg = 0;
      for (const factor in factorMoodSum) {
        const avg = factorMoodSum[factor] / factorCounts[factor];
        if (avg > bestAvg && factorCounts[factor] >= 2) {
          bestAvg = avg;
          bestFactor = factor;
        }
      }

      if (bestFactor) {
        const factorNames = {
          'sleep': 'good sleep',
          'exercise': 'exercise',
          'social': 'social interaction',
          'work': 'work-related activities',
          'weather': 'favorable weather',
          'food': 'regular meals'
        };

        const insight = document.createElement('div');
        insight.className = 'insight-box';
        insight.innerHTML = `<i class="fas fa-lightbulb"></i> You tend to feel better on days with ${factorNames[bestFactor] || bestFactor}. Try to incorporate this more often.`;
        insightsContent.appendChild(insight);
      }

      // Check mood trend
      const last7 = moods.slice(-7);
      if (last7.length >= 5) {
        const avgFirst = last7.slice(0, 3).reduce((sum, e) => sum + e.mood, 0) / 3;
        const avgLast = last7.slice(-3).reduce((sum, e) => sum + e.mood, 0) / 3;

        if (avgLast > avgFirst + 0.5) {
          const insight = document.createElement('div');
          insight.className = 'insight-box';
          insight.innerHTML = `<i class="fas fa-arrow-trend-up"></i> Your mood has been improving over the past week. Keep up the positive momentum!`;
          insightsContent.appendChild(insight);
        } else if (avgLast < avgFirst - 0.5) {
          const insight = document.createElement('div');
          insight.className = 'insight-box';
          insight.innerHTML = `<i class="fas fa-heart"></i> Your mood has been lower recently. Consider reaching out to someone you trust or exploring our <a href="counselors.html" style="color:inherit;font-weight:600;">support resources</a>.`;
          insightsContent.appendChild(insight);
        }
      }
    }

    // ===== HISTORY RENDERING =====
    function renderHistory() {
      const moods = safeRead("mh_moods");
      const recent = moods.slice(-10).reverse();

      if (recent.length === 0) {
        moodHistory.innerHTML = "<div class='empty-state'><i class='fas fa-calendar-check'></i><p>No mood entries yet.<br>Start tracking above to see your history!</p></div>";
        return;
      }

      moodHistory.innerHTML = "";
      const moodEmojis = ["", "üò¢", "üòü", "üòê", "üôÇ", "üòä"];
      const energyLabels = ["", "Very Low", "Low", "Moderate", "High", "Very High"];
      const factorNames = {
        'sleep': 'Sleep',
        'exercise': 'Exercise',
        'social': 'Social',
        'work': 'Work',
        'weather': 'Weather',
        'food': 'Food'
      };

      recent.forEach(m => {
        const div = document.createElement("div");
        div.className = "mood-entry";

        let factorsHTML = '';
        if (m.factors && m.factors.length > 0) {
          factorsHTML = '<div class="mood-entry-factors">' +
            m.factors.map(f => `<span class="factor-tag">${factorNames[f] || f}</span>`).join('') +
            '</div>';
        }

        let energyHTML = '';
        if (m.energy) {
          energyHTML = `<div class="mood-entry-energy">Energy: ${energyLabels[m.energy]}</div>`;
        }

        div.innerHTML = `
          <div class="mood-entry-header">
            <span class="mood-entry-date">${new Date(m.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
            <span class="mood-entry-mood">${moodEmojis[m.mood]}</span>
          </div>
          ${factorsHTML}
          ${energyHTML}
          ${m.note ? '<div class="mood-entry-note">' + m.note + '</div>' : ""}
        `;
        moodHistory.appendChild(div);
      });
    }

    // ===== INITIALIZATION =====
    initTheme();
    updateStats();
    renderHistory();
    renderChart();
    generateInsights();
  </script>
</body>

</html>